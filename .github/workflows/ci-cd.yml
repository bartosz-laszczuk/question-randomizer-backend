name: CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration Release --no-restore

    - name: Run unit tests
      run: dotnet test tests/QuestionRandomizer.UnitTests/QuestionRandomizer.UnitTests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=unit-tests.trx"

    - name: Run Controllers integration tests
      run: dotnet test tests/QuestionRandomizer.IntegrationTests.Controllers/QuestionRandomizer.IntegrationTests.Controllers.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=integration-tests-controllers.trx"

    - name: Run Minimal API integration tests
      run: dotnet test tests/QuestionRandomizer.IntegrationTests.MinimalApi/QuestionRandomizer.IntegrationTests.MinimalApi.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=integration-tests-minimal.trx"

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/*.trx'
        reporter: dotnet-trx

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          src/QuestionRandomizer.Api.Controllers/bin/Release
          src/QuestionRandomizer.Api.MinimalApi/bin/Release

  # Job 2: Code Quality and Security
  code-quality:
    name: Code Quality and Security
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Check for vulnerable packages
      run: dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerable-packages.txt
      continue-on-error: true

    - name: Upload vulnerability report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vulnerability-report
        path: vulnerable-packages.txt

    - name: Run code analysis
      run: dotnet build --configuration Release /p:EnableNETAnalyzers=true /p:AnalysisLevel=latest /p:TreatWarningsAsErrors=false

  # Job 3: Build Docker Images (Controllers API)
  build-docker-controllers:
    name: Build Docker Image (Controllers)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub (Optional)
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: src/QuestionRandomizer.Api.Controllers/Dockerfile
        push: false
        tags: |
          question-randomizer-controllers:${{ github.sha }}
          question-randomizer-controllers:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Job 4: Build Docker Images (Minimal API)
  build-docker-minimal:
    name: Build Docker Image (Minimal API)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub (Optional)
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: src/QuestionRandomizer.Api.MinimalApi/Dockerfile
        push: false
        tags: |
          question-randomizer-minimal:${{ github.sha }}
          question-randomizer-minimal:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Job 5: Deploy to Staging (Optional)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-docker-controllers, build-docker-minimal]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging-api.yourdomain.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add your deployment commands here
        # Examples:
        # - Azure: az webapp deploy
        # - AWS: aws ecs update-service
        # - Kubernetes: kubectl apply -f k8s/
        # - Docker Compose: docker-compose up -d

    - name: Run smoke tests
      run: |
        echo "Running smoke tests against staging..."
        # Add smoke test commands
        # curl -f https://staging-api.yourdomain.com/health || exit 1

  # Job 6: Deploy to Production (Manual Approval Required)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-docker-controllers, build-docker-minimal]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    environment:
      name: production
      url: https://api.yourdomain.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        # Add your deployment commands here

    - name: Run smoke tests
      run: |
        echo "Running smoke tests against production..."
        # curl -f https://api.yourdomain.com/health || exit 1

    - name: Notify team
      if: success()
      run: |
        echo "Deployment successful! Notifying team..."
        # Add notification logic (Slack, email, etc.)
